App.addChild("MoipForm",_.extend({el:"form.moip",events:{"blur input:not(#payment_card_cpf):not(#user_document_payment_slip)":"checkInput"},getMoipToken:function(e){var q=this;$("#MoipWidget").length>0?_.isFunction(e)&&e():$.post("/payment/moip/"+this.contributionId+"/get_moip_token").success(function(i){q.paymentChoice.$("input").attr("disabled","disabled"),"fail"==i.get_token_response.status?q.checkoutFailure({Code:0,Mensagem:i.get_token_response.message}):(q.createMoipWidget(i),_.isFunction(e)&&e(i))})},createMoipWidget:function(e){widget_tag=$("<div/>").attr({id:e.widget_tag.tag_id,"data-token":e.widget_tag.token,"callback-method-success":e.widget_tag.callback_success,"callback-method-error":e.widget_tag.callback_error}),$("#catarse_moip_form").prepend(widget_tag)},checkoutFailure:function(e){this.loader.hide();var q=e.length>0?e[0]:e;914==q.Codigo&&(q.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a p\xe1gina</a> e repetir a opera\xe7\xe3o de pagamento.'),this.message.find(".message-text").html(q.Mensagem),this.message.slideDown("slow")},checkoutSuccessful:function(e){var q=this;$.post("/payment/moip/"+this.contributionId+"/moip_response",{response:e}).success(function(){if(q.loader.hide(),"Cancelado"==e.Status)return q.checkoutFailure({Codigo:0,Mensagem:e.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(e.url&&"block"!=$("#payment_type_cards_section").css("display")){var i=$('<a class="alt-link" target="__blank">Clique aqui para ver o boleto e completar o pagamento.</a>');i.attr("href",e.url),$(".link_content").empty().html(i),$("#payment-slip-link").slideDown("slow")}else{var a=$("#project_review").data("thank-you-path");a?location.href=a:location.href="/"}})},activate:function(){this.message=this.$(".payment-error-message"),this.contributionId=$("input#contribution_id").val(),this.projectId=$("input#contribution_project_id").val(),this.loader=this.$(".loader img"),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this),this.setupForm()}},Skull.Form)),App.views.MoipForm.UserDocument={onContentClick:function(){window.setTimeout(function(){app.moipForm.checkoutSuccessful({StatusPagamento:"Success"})},2e3)},onUserDocumentKeyup:function(e){var q=$(e.currentTarget),i=q.val();q.prop("maxlength",18);var a=this.validateCpf(i),t=this.validateCnpj(i.replace(/[\/.\-\_ ]/g,"")),o=i.replace(/[.\-\_ ]/g,"").length;o>10?("payment_card_cpf"!=q.attr("id")&&(11==o?q.mask("999.999.999-99?999"):14==o&&q.mask("99.999.999/9999-99"),14==o&&11==o||q.unmask()),a||t?($("[data-error-for="+q.prop("id")+"]").hide(),q.addClass("ok").removeClass("error"),$.ajax({url:"/projects/"+this.moipForm.projectId+"/contributions/"+this.moipForm.contributionId,type:"PUT",data:{contribution:{payer_document:i}}})):q.trigger("invalid")):q.trigger("invalid")},validateCpf:function(e){var q,i,a=0;e=e.replace(/[.\-\_ ]/g,"");var t=Math.floor(parseFloat(e)/100),$=100*t;for(q=0;q<=8;q++)a+=t%10*(q+2),t=Math.floor(t/10);for(i=a%11<2?0:11-a%11,$+=10*i,a=0,t=Math.floor($/10),q=0;q<=9;q++)a+=t%10*(q+2),t=Math.floor(t/10);return i=a%11<2?0:11-a%11,$+=i,parseFloat(e)===$},validateCnpj:function(e){var q,i,a,t,$,o,n,l;if(l=1,e.length<14&&e.length<15)return!1;for(t=0;t<e.length-1;t++)if(e.charAt(t)!=e.charAt(t+1)){l=0;break}if(l)return!1;for(n=e.length-2,q=e.substring(0,n),i=e.substring(n),a=0,o=n-7,t=n;t>=1;t--)a+=q.charAt(n-t)*o--,o<2&&(o=9);if($=a%11<2?0:11-a%11,$!=i.charAt(0))return!1;for(n+=1,q=e.substring(0,n),a=0,o=n-7,t=n;t>=1;t--)a+=q.charAt(n-t)*o--,o<2&&(o=9);return $=a%11<2?0:11-a%11,$==i.charAt(1)}},App.views.MoipForm.addChild("PaymentAccount",_.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup","click .link_content a":"onContentClick"},activate:function(){this.moipForm=this.parent,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(e){var q=$(e.currentTarget).val();this.$("input#build_account_link").attr("disabled",!(""!=q&&void 0!=q))},onBuildAccountClick:function(e){var q=this;e.preventDefault(),$(e.currentTarget).hide(),q.moipForm.loader.show(),q.moipForm.getMoipToken(function(){var e={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(e)})}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentCard",_.extend({el:"#payment_type_cards_section",events:{"keyup #payment_card_number":"onKeyupPaymentCardNumber","click #credit_card_submit":"onSubmit","blur #payment_card_cpf":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent,this.$("#payment_card_number").payment("formatCardNumber"),window.app.maskAllElements()},onKeyupPaymentCardNumber:function(e){this.$("#payment_card_flag").html(this.getCardFlag($(e.currentTarget).val()))},onSubmit:function(e){var q=this;return e.preventDefault(),!!q.moipForm.validate()&&(q.moipForm.loader.show(),void q.moipForm.getMoipToken(function(){var e={Forma:"CartaoCredito",Instituicao:q.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:q.$("input#payment_card_number").val(),Expiracao:q.$("input#payment_card_date").val(),CodigoSeguranca:q.$("input#payment_card_source").val(),Portador:{Nome:q.$("input#payment_card_name").val(),DataNascimento:q.$("input#payment_card_birth").val(),Telefone:q.$("input#payment_card_phone").val(),Identidade:q.$("input#payment_card_cpf").val()}}};MoipWidget(e)}))},getCardFlag:function(e){return $.payment.cardType(e).toUpperCase()}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentChoice",{el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(e){$(".payment_section").fadeOut("fast",function(){var q=$(e.currentTarget).attr("id");$("#"+q+"_section").fadeIn("fast")})},activate:function(){this.$("input#payment_type_cards").click()}}),App.views.MoipForm.addChild("PaymentSlip",_.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","blur #user_document_payment_slip":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent},onBuildBoletoClick:function(e){var q=this;return e.preventDefault(),!!q.moipForm.validate()&&($(e.currentTarget).hide(),this.$("#payment-slip-instructions").slideUp("slow"),q.moipForm.loader.show(),void q.moipForm.getMoipToken(function(){var e={Forma:"BoletoBancario"};MoipWidget(e)}))}},App.views.MoipForm.UserDocument)),$(function(){app.createViewGetters()});